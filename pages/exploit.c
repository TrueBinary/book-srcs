/* exploit.c */
#include <stdio.h>
#include <memory.h>
#include <sys/mman.h>

/* Tamanho de uma página. */
#define PAGE_SIZE 4096

/* Código que vai ser injetado. */
const unsigned char code[] = {
  0x48, 0x89, 0xf8,   /* mov rax,rdi; */
  0x48, 0x01, 0xf8,   /* add rax,rdi; */
  0xc3                /* ret; */
};

int main(int argc, char *argv)
{
  long (*fp)(long);
  int x = 3, value;

  /* Aloca uma única página. 
     Poderíamos alocar o tamanho suficiente para caber o código, mas
     mmap vai alocar uma página de qualquer jeito! */
  fp = mmap(NULL, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_ANONYMOUS | MAP_PRIVATE, -1, 0);
  if (fp != NULL)
  {
    /* Copia o código para a página */
    memcpy(fp, code, sizeof(code));

    /* Desabilita a escrita na página e habilita a execução. */
    mprotect(fp, PAGE_SIZE, PROT_READ | PROT_EXEC);

    /* Executa o código injetado via ponteiro. */
    value = fp(x);

    /* Dealoca a página! */
    munmap(fp, PAGE_SIZE);

    printf("O dobro de %d é %d.\n", x, value);
  }
  else
    puts("Não consegui alocar uma página!");

  return 0; 
}
